# -*- coding: utf-8 -*-
"""training_colab.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1S2D086ZAqomMvs9cFGZzCDQh7BXWjYSf

# Cell 1: ä¸€é”®é…ç½®ç¯å¢ƒ + æ‹‰å– Dave çš„ä¿®å¤ç‰ˆä»£ç 
"""

# ==============================================================================
# Cell 1: ä¸€é”®é…ç½®ç¯å¢ƒ + æ‹‰å– Dave çš„ä¿®å¤ç‰ˆä»£ç 
# ==============================================================================
import os
import time
import shutil

# --- 1. å®‰è£…åŸºç¡€ç¯å¢ƒ (Conda) ---
print("â³ æ­£åœ¨å®‰è£… Conda...")
try:
    import condacolab
except ImportError:
    !pip install -q condacolab
    import condacolab
condacolab.install()
time.sleep(5)

print("âœ… Conda å°±ç»ªï¼é…ç½® Python 3.9 + JAX...")

# --- 2. é…ç½® Python ç¯å¢ƒ (é”æ­»ç‰ˆæœ¬) ---
!conda create -n mobilenerf python=3.9 -y
# å®‰è£… CUDA, JAX, Flax (å¿…é¡»ä¸¥æ ¼åŒ¹é…)
!source activate mobilenerf && conda install -c conda-forge cudatoolkit=11.8 cudnn=8.8 -y
!source activate mobilenerf && pip install "jax[cuda11_pip]==0.3.25" -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html --no-deps
!source activate mobilenerf && pip install "flax==0.5.3" scipy "optax==0.1.4" "chex==0.1.5" "absl-py" --no-deps
!source activate mobilenerf && pip install tqdm opencv-python-headless matplotlib gin-config msgpack typing-extensions opt_einsum toolz rich PyYAML numpy==1.23.5


print("âœ… è¿è¡Œç¯å¢ƒæ­å»ºå®Œæ¯•ï¼")

# --- 3. æ‹‰å–ä½ çš„ GitHub ä»£ç  (jax3d_David) ---
# ä½ çš„ä»“åº“åœ°å€
MY_REPO = "https://github.com/Davecodingking/jax3d_David.git"
TARGET_DIR = "/content/jax3d"

print(f"ğŸš€ æ­£åœ¨æ‹‰å–ä½ çš„ä»£ç : {MY_REPO}")

# æ¸…ç†æ—§ç›®å½•
if os.path.exists(TARGET_DIR): shutil.rmtree(TARGET_DIR)
if os.path.exists("/content/jax3d_David"): shutil.rmtree("/content/jax3d_David")

# å…‹éš†ä»“åº“
!git clone {MY_REPO}

# ç»“æ„ä¿®æ­£: æŠŠ jax3d_David æ”¹åä¸º jax3d (Python æ‰èƒ½è¯†åˆ«)
if os.path.exists("/content/jax3d_David"):
    shutil.move("/content/jax3d_David", TARGET_DIR)
    print("âœ… ä»£ç å·²å°±ä½ (jax3d_David -> jax3d)")
else:
    print("âŒ å…‹éš†å¤±è´¥ï¼Œè¯·æ£€æŸ¥ GitHub ä»“åº“æ˜¯å¦ä¸ºç©ºæˆ–åœ°å€é”™è¯¯ã€‚")

print("ğŸ‰ å‡†å¤‡å°±ç»ªï¼è¯·ä¸Šä¼ æ•°æ®åŒ… MyNeRFData.zip å¹¶è¿è¡Œä¸‹ä¸€æ­¥ã€‚")

"""# Cell 2-Drive: ä» Google Drive å¤åˆ¶ MyNeRFData.zip"""

"""# Cell 2-Drive: ä» Google Drive å¤åˆ¶ MyNeRFData.zipï¼ˆå¯é€‰ï¼‰"""

import os
from google.colab import drive

drive_zip_path = "/content/drive/MyDrive/MyNeRFData.zip"
local_zip_path = "/content/MyNeRFData.zip"

print("ğŸ“‚ [å¯é€‰] æ­£åœ¨æ£€æŸ¥ Drive ä¸Šæ˜¯å¦å·²æœ‰ MyNeRFData.zip ...")

if not os.path.exists("/content/drive"):
    drive.mount("/content/drive")

if os.path.exists(local_zip_path):
    print(f"âœ… æœ¬åœ°å·²å­˜åœ¨ {local_zip_path}ï¼Œè·³è¿‡ä» Drive å¤åˆ¶ã€‚")
elif os.path.exists(drive_zip_path):
    print(f"ğŸ”„ åœ¨ Drive æ‰¾åˆ°æ•°æ®é›†: {drive_zip_path}")
    print("   -> æ­£åœ¨å¤åˆ¶åˆ°æœ¬åœ° /content/MyNeRFData.zip ...")
    os.system(f"cp '{drive_zip_path}' '{local_zip_path}'")
    print("âœ… å¤åˆ¶å®Œæˆï¼å¯ä»¥ç›´æ¥è¿è¡Œè§£å‹ Cellã€‚")
else:
    print("âš ï¸ Drive ä¸­æœªæ‰¾åˆ° MyNeRFData.zipã€‚")
    print("   -> è‹¥éœ€è¦è¿œç¨‹åŠ è½½ï¼Œè¯·å…ˆæŠŠæ•°æ®é›†ä¸Šä¼ åˆ°: MyDrive/MyNeRFData.zip")
    print("   -> æˆ–è€…æŒ‰åŸæµç¨‹ï¼Œåœ¨å·¦ä¾§æ–‡ä»¶æ æ‰‹åŠ¨ä¸Šä¼ åˆ° /content/MyNeRFData.zip")

"""# Cell 3: æ•°æ®å‡†å¤‡ï¼ˆè§£å‹ Dataset + ç»“æ„ä¿®å¤ + æŒ‚è½½ Driveï¼‰"""

# ==========================================
# æ­¥éª¤ 2 (ä¿®å¤ç‰ˆ): æ™ºèƒ½è§£å‹ä¸å®Œæ•´æ€§æ£€æŸ¥
# è¯´æ˜ï¼šè¯·ä¿è¯ ZIP å†…éƒ¨é¡¶å±‚æ–‡ä»¶å¤¹å‘½åä¸º MyNeRFDataï¼Œ
#       ä¸”æœ€ç»ˆå±•å¼€è·¯å¾„ä¸º data/custom/MyNeRFDataï¼Œå¯¹åº” mobilenerf ä¸­ object_name="MyNeRFData"
# ==========================================
import os
import zipfile

zip_path = '/content/MyNeRFData.zip'
extract_path = '/content/jax3d/jax3d/projects/mobilenerf/data/custom/MyNeRFData'

# 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if not os.path.exists(zip_path):
    print("âŒ é”™è¯¯ï¼šæ ¹æœ¬æ²¡æ‰¾åˆ° /content/MyNeRFData.zipï¼")
    print("ğŸ‘‰ è¯·å°†æ–‡ä»¶æ‹–å…¥å·¦ä¾§æ–‡ä»¶æ ï¼Œå¹¶ç­‰å¾…ä¸Šä¼ å®Œæˆã€‚")
    assert False

# 2. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸå (å…³é”®æ­¥éª¤)
if not zipfile.is_zipfile(zip_path):
    print("âŒ è‡´å‘½é”™è¯¯ï¼šZIP æ–‡ä»¶å·²æŸåæˆ–æœªä¸Šä¼ å®Œæˆï¼")
    print("ğŸ’¡ åŸå› ï¼šé€šå¸¸æ˜¯å› ä¸ºä½ åœ¨ä¸Šä¼ è¿›åº¦æ¡èµ°å®Œä¹‹å‰å°±ç‚¹å‡»äº†è¿è¡Œã€‚")
    print("ğŸ‘‰ è§£å†³ï¼šè¯·åœ¨å·¦ä¾§åˆ é™¤è¯¥æ–‡ä»¶ï¼Œé‡æ–°ä¸Šä¼ ï¼ŒåŠ¡å¿…ç­‰å¾…ä¸‹æ–¹è¿›åº¦åœˆå®Œå…¨æ¶ˆå¤±ï¼")
    # æ‰“å°æ–‡ä»¶å¤§å°çœ‹çœ‹
    file_size = os.path.getsize(zip_path) / (1024 * 1024)
    print(f"   å½“å‰æ–‡ä»¶å¤§å°ä»…ä¸º: {file_size:.2f} MB (å¦‚æœè¿™ä¸ªæ•°å¾ˆå°ï¼Œè¯´æ˜è‚¯å®šæ²¡ä¼ å®Œ)")
    assert False

print(f"âœ… ZIP æ–‡ä»¶å®Œæ•´ ({os.path.getsize(zip_path)/1024/1024:.2f} MB)ã€‚å‡†å¤‡è§£å‹...")

# 3. åˆ›å»ºç›®å½•
if not os.path.exists(extract_path):
    os.makedirs(extract_path)

# 4. è§£å‹
print(f"ğŸ“‚ æ­£åœ¨è§£å‹åˆ°: {extract_path}")
# ä½¿ç”¨ python è‡ªå¸¦åº“è§£å‹ï¼Œæ¯” shell å‘½ä»¤æ›´ç¨³
try:
    with zipfile.ZipFile(zip_path, 'r') as zip_ref:
        zip_ref.extractall(extract_path)
    print("âœ… è§£å‹æˆåŠŸï¼")
except Exception as e:
    print(f"âŒ è§£å‹å¤±è´¥: {e}")
    assert False

# 5. å†æ¬¡æ ¸å®å†…å®¹
# æœ‰æ—¶å€™ zip åŒ…é‡Œè‡ªå¸¦äº†ä¸€å±‚æ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬éœ€è¦ç¡®è®¤ json åœ¨å“ª
print("ğŸ§ æ ¸å®æ–‡ä»¶ä½ç½®...")
found_json = False
for root, dirs, files in os.walk(extract_path):
    if "transforms_train.json" in files:
        print(f"âœ… æˆåŠŸæ‰¾åˆ°é…ç½®æ–‡ä»¶: {os.path.join(root, 'transforms_train.json')}")
        found_json = True
        break

if not found_json:
    print("âš ï¸ è­¦å‘Šï¼šè§£å‹æˆåŠŸï¼Œä½†æ²¡æ‰¾åˆ° transforms_train.jsonã€‚")
    print("ğŸ‘‡ è¯·æ£€æŸ¥ä¸‹é¢çš„æ–‡ä»¶ç»“æ„ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯å¥—äº†ä¸€å±‚æ–‡ä»¶å¤¹ï¼Ÿ")
    for root, dirs, files in os.walk(extract_path):
        level = root.replace(extract_path, '').count(os.sep)
        indent = ' ' * 4 * (level)
        print('{}{}/'.format(indent, os.path.basename(root)))
        subindent = ' ' * 4 * (level + 1)
        for f in files[:5]: # åªæ˜¾ç¤ºå‰5ä¸ªæ–‡ä»¶
            print('{}{}'.format(subindent, f))
else:
    print("ğŸ‰ æ•°æ®å‡†å¤‡å®Œç¾å°±ç»ªï¼è¯·ç»§ç»­è¿è¡Œ Step 3ã€‚")

import os
import shutil

nested_dir = '/content/jax3d/jax3d/projects/mobilenerf/data/custom/MyNeRFData/MyNeRFData'
target_dir = '/content/jax3d/jax3d/projects/mobilenerf/data/custom/MyNeRFData'

print("ğŸ”§ æ­£åœ¨æ£€æµ‹æ˜¯å¦å¥—å¨ƒ...")

if os.path.exists(nested_dir):
    print(f"âš ï¸ å‘ç°å¥—å¨ƒæ–‡ä»¶å¤¹ï¼æ­£åœ¨æŠŠæ–‡ä»¶ä» {nested_dir} æ¬å‡ºæ¥...")

    # éå†å¥—å¨ƒæ–‡ä»¶å¤¹é‡Œçš„æ‰€æœ‰æ–‡ä»¶ï¼Œç§»åŠ¨åˆ°å¤–é¢
    for filename in os.listdir(nested_dir):
        src = os.path.join(nested_dir, filename)
        dst = os.path.join(target_dir, filename)

        # å¦‚æœç›®æ ‡å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤ï¼Œé˜²æ­¢æŠ¥é”™
        if os.path.exists(dst):
            if os.path.isdir(dst): shutil.rmtree(dst)
            else: os.remove(dst)

        shutil.move(src, dst)
        print(f"  -> ç§»åŠ¨: {filename}")

    # åˆ æ‰ç©ºçš„å¥—å¨ƒå£³å­
    os.rmdir(nested_dir)
    print("âœ… æ¬å®¶å®Œæˆï¼ç»“æ„å·²ä¿®å¤ã€‚")
else:
    print("â„¹ï¸ æ²¡å‘ç°å¥—å¨ƒæ–‡ä»¶å¤¹ã€‚")
    # æ£€æŸ¥ä¸€ä¸‹æ–‡ä»¶åˆ°åº•åœ¨å“ª
    if os.path.exists(os.path.join(target_dir, "transforms_train.json")):
        print("âœ… ç¡®è®¤ï¼šjson æ–‡ä»¶å·²ç»åœ¨æ­£ç¡®ä½ç½®äº†ã€‚")
    else:
        print("âŒ ä¾ç„¶æ‰¾ä¸åˆ°æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥å·¦ä¾§æ–‡ä»¶æ ç¡®è®¤è·¯å¾„ã€‚")

import os
import time
import threading
import shutil
import re
from google.colab import drive
from IPython import get_ipython

# 1. ç¯å¢ƒå‡†å¤‡
if not os.path.exists('/content/drive'):
    drive.mount('/content/drive')

project_dir = '/content/jax3d/jax3d/projects/mobilenerf'
if os.path.exists(project_dir):
    os.chdir(project_dir)
    os.environ['PYTHONPATH'] += ":/content/jax3d"
else:
    print(f"âŒ æ‰¾ä¸åˆ°é¡¹ç›®ç›®å½•: {project_dir}")

"""# Cell 4: ç¯å¢ƒé…ç½® ï¼ˆPyTorch 2.1 + NumPy 1.26 + PyTorch3D Wheelï¼‰

"""

"""# Cell 8-UV: 01_preprocess_raster ä¸“ç”¨ç¯å¢ƒï¼ˆWheelåŠ é€Ÿ + NumPyä¿®å¤ç‰ˆï¼‰"""

import os

# 1. åˆ›å»ºç¯å¢ƒ (Python 3.10)
print("ğŸš€ [Hybrid UV Env] æ­£åœ¨åˆ›å»º Python 3.10 ç¯å¢ƒ...")
!conda create -n hybrid_uv_wheel python=3.10 -y

# 2. å®‰è£… PyTorch 2.1.0 + CUDA 11.8 + â˜…NumPy 1.26.4â˜…
# å…³é”®ä¿®å¤ï¼šæ˜¾å¼åŠ ä¸Š numpy=1.26.4ï¼Œé˜²æ­¢å®‰è£… NumPy 2.x
print("â³ æ­£åœ¨å®‰è£… PyTorch 2.1.0 å’Œ NumPy 1.26.4...")
!source activate hybrid_uv_wheel && conda install -y \
    pytorch=2.1.0 torchvision=0.16.0 torchaudio=2.1.0 \
    pytorch-cuda=11.8 \
    numpy=1.26.4 \
    -c pytorch -c nvidia

# 3. å®‰è£…ä¾èµ– (fvcore, iopath)
# ä½¿ç”¨ pip å®‰è£…æ—¶ä¹Ÿé™åˆ¶ numpy ç‰ˆæœ¬ï¼Œé˜²æ­¢è¢«å‡çº§
print("â³ æ­£åœ¨å®‰è£…åŸºç¡€ä¾èµ–...")
!source activate hybrid_uv_wheel && pip install "numpy<2" fvcore iopath matplotlib pillow


# 4. å®‰è£… PyTorch3D å®˜æ–¹ Wheel åŒ… (GPU åŠ é€Ÿæ ¸å¿ƒ)
print("â³ æ­£åœ¨å®‰è£… PyTorch3D å®˜æ–¹åŠ é€ŸåŒ…...")
!source activate hybrid_uv_wheel && pip install --no-index --no-cache-dir pytorch3d -f https://dl.fbaipublicfiles.com/pytorch3d/packaging/wheels/py310_cu118_pyt210/download.html

print("\nâœ… ç¯å¢ƒé…ç½®å®Œæˆï¼NumPyç‰ˆæœ¬å·²é”å®šï¼ŒCUDAåŠ é€Ÿå·²å°±ç»ªã€‚")

"""# Cell 8: Hybrid Workflow ç¯å¢ƒé…ç½®ï¼ˆåŸºäº Colab é»˜è®¤ç¯å¢ƒï¼‰"""

print("\nğŸš€ [Hybrid Env] é…ç½® Torch + PyTorch3D ç¯å¢ƒï¼ˆä½¿ç”¨ Colab é»˜è®¤ Pythonï¼‰...")
!pip install --upgrade pip
!pip install "numpy<2"
!pip install torch==2.1.0+cu118 torchvision==0.16.0+cu118 torchaudio==2.1.0+cu118 -f https://download.pytorch.org/whl/torch_stable.html

# !pip install --upgrade pip
# !pip install "numpy<2" --force-reinstall
# !pip install torch==2.1.0+cu118 torchvision==0.16.0+cu118 torchaudio==2.1.0+cu118 -f https://download.pytorch.org/whl/torch_stable.html

"""# Cell 5: Overlay æ£€æŸ¥ æ— åè½¬"""

import os

# å®šä¹‰å¯¹æ¯”è„šæœ¬å†…å®¹
diagnostic_script = r'''
import os
import json
import torch
import numpy as np
import matplotlib.pyplot as plt
from PIL import Image
from pytorch3d.io import load_obj
from pytorch3d.structures import Meshes
from pytorch3d.renderer import (
    PerspectiveCameras, RasterizationSettings, MeshRasterizer,
    MeshRenderer, SoftPhongShader, AmbientLights, TexturesVertex
)

# ================= CONFIG =================
DATA_ROOT = "data/custom/MyNeRFData"
OBJ_NAME = "sponza_gt.obj"
TRANSFORMS = "transforms_train.json"
DEVICE = "cuda"
TARGET_FRAMES = [0, 29] # ç¬¬ 1 å¸§ å’Œ ç¬¬ 30 å¸§
# ==========================================

def run_comparison():
    print(f"ğŸš€ å¯åŠ¨ç»“æ„å¯¹æ¯”è¯Šæ–­: æ£€æŸ¥ Index {TARGET_FRAMES}...")

    # 1. åŠ è½½æ¨¡å‹
    obj_path = os.path.join(DATA_ROOT, OBJ_NAME)
    verts, faces, _ = load_obj(obj_path)
    verts = verts.to(DEVICE).float()
    faces_idx = faces.verts_idx.to(DEVICE).long()

    # æ³•çº¿ç€è‰²ï¼šè§‚å¯Ÿå‡ ä½•è½®å»“
    temp_mesh = Meshes(verts=[verts], faces=[faces_idx])
    normals = temp_mesh.verts_normals_packed()
    verts_rgb = (normals + 1.0) / 2.0
    textures = TexturesVertex(verts_features=verts_rgb[None])
    mesh = Meshes(verts=[verts], faces=[faces_idx], textures=textures)

    # 2. åŠ è½½å…ƒæ•°æ®
    with open(os.path.join(DATA_ROOT, TRANSFORMS), "r") as f:
        meta = json.load(f)

    camera_angle_x = float(meta["camera_angle_x"])
    lights = AmbientLights(device=DEVICE, ambient_color=((1.0, 1.0, 1.0),))

    results = []

    for idx in TARGET_FRAMES:
        frame = meta["frames"][idx]
        img_path = os.path.join(DATA_ROOT, frame["file_path"] + ".png")
        if not os.path.exists(img_path):
            img_path = img_path.replace(".png", ".jpg")

        gt_image = np.array(Image.open(img_path).convert("RGB")) / 255.0
        H, W, _ = gt_image.shape

        c2w = np.array(frame["transform_matrix"], dtype=np.float32)
        c2w_t = torch.from_numpy(c2w).to(DEVICE)

        R_c2w = c2w_t[:3, :3]
        C = c2w_t[:3, 3]
        R_w2c = R_c2w.t()
        T_w2c = -R_w2c @ C

        focal = 0.5 * W / np.tan(0.5 * camera_angle_x)
        cameras = PerspectiveCameras(
            device=DEVICE,
            R=R_w2c.t().unsqueeze(0), # PyTorch3D å†…éƒ¨ä½¿ç”¨è¡Œå‘é‡ä¹˜æ³•ï¼Œæ‰€ä»¥ä¼ è½¬ç½®
            T=T_w2c.unsqueeze(0),
            focal_length=((focal, focal),),
            principal_point=((W/2, H/2),),
            image_size=((H, W),),
            in_ndc=False
        )

        raster_settings = RasterizationSettings(image_size=(H, W), blur_radius=0.0, faces_per_pixel=1, cull_backfaces=False)
        renderer = MeshRenderer(
            rasterizer=MeshRasterizer(cameras=cameras, raster_settings=raster_settings),
            shader=SoftPhongShader(device=DEVICE, cameras=cameras, lights=lights)
        )

        render_rgba = renderer(mesh)[0].cpu().numpy()
        render_rgb = render_rgba[..., :3]
        results.append((gt_image, render_rgb, idx))

    fig, axes = plt.subplots(2, 2, figsize=(20, 16))
    for i, (gt, ren, idx) in enumerate(results):
        axes[i, 0].imshow(gt)
        axes[i, 0].set_title(f"Frame {idx}: Unity Photo", fontsize=16)
        axes[i, 0].axis("off")

        axes[i, 1].imshow(ren)
        axes[i, 1].set_title(f"Frame {idx}: Pytorch3D Render (Raw)", fontsize=16)
        axes[i, 1].axis("off")

    plt.tight_layout()
    output_name = "frame_comparison_result.png"
    plt.savefig(output_name)
    print(f"âœ… å¯¹æ¯”å›¾å·²ç”Ÿæˆ: {output_name}")

if __name__ == "__main__":
    run_comparison()
'''

# å†™å…¥æ–‡ä»¶
with open("compare_script.py", "w") as f:
    f.write(diagnostic_script)

# æ‰§è¡Œè¯Šæ–­
print("ğŸš€ æ­£åœ¨è¿è¡Œå¯¹æ¯”è¯Šæ–­...")
!source activate hybrid_uv_wheel && export MPLBACKEND=Agg && python compare_script.py

# æ˜¾ç¤ºç»“æœ
from IPython.display import Image, display
if os.path.exists("frame_comparison_result.png"):
    display(Image("frame_comparison_result.png"))

"""# Cell 6:Hybrid Pipeline Step 1 - é¢„è®¡ç®— UV (PyTorch3D)"""

"""# Cell 9: Hybrid Pipeline Step 1 - é¢„è®¡ç®— UV (è¿è¡Œ)"""

import os
from IPython import get_ipython
from google.colab import drive
import numpy as np

PROJECT_ROOT_HYBRID = "/content/jax3d/jax3d/projects/mobilenerf"
DRIVE_HYBRID_ROOT = "/content/drive/MyDrive/Hybrid_Pipeline"
HYBRID_DATA_ROOT = "data/custom/MyNeRFData"
HYBRID_OBJ_NAME = "sponza_gt_unwarpped.obj"
HYBRID_TRANSFORMS = "transforms_train.json"
HYBRID_UV_OUTPUT = "uv_lookup.npz"

print("\nğŸš€ [Hybrid 1/2] é¢„è®¡ç®— UV æ˜ å°„ (GPU åŠ é€Ÿæ¨¡å¼)...")

if not os.path.exists("/content/drive"):
    drive.mount("/content/drive")

if not os.path.exists(DRIVE_HYBRID_ROOT):
    os.makedirs(DRIVE_HYBRID_ROOT)

if os.path.exists(PROJECT_ROOT_HYBRID):
    os.chdir(PROJECT_ROOT_HYBRID)

    # æ³¨æ„ï¼šè¿™é‡Œæ¿€æ´»çš„æ˜¯ hybrid_uv_wheel ç¯å¢ƒ
    cmd = f"""
    source activate hybrid_uv_wheel && \
    python 01_preprocess_raster.py \
      --data_root='{HYBRID_DATA_ROOT}' \
      --obj_name='{HYBRID_OBJ_NAME}' \
      --transforms='{HYBRID_TRANSFORMS}' \
      --output='{HYBRID_UV_OUTPUT}' \
      --downscale=1 \
      --device='cuda'
    """

    get_ipython().system(f"bash -c '{cmd}'")

    uv_path = os.path.join(PROJECT_ROOT_HYBRID, HYBRID_DATA_ROOT, HYBRID_UV_OUTPUT)
    if os.path.exists(uv_path):
        data = np.load(uv_path, allow_pickle=True)
        print(f"âœ… UV æ˜ å°„ç”Ÿæˆå®Œæˆï¼Œå½¢çŠ¶: {data['uv'].shape}")
        # å¤åˆ¶åˆ° Google Drive å¤‡ä»½
        os.system(f"cp '{uv_path}' '{DRIVE_HYBRID_ROOT}/'")
        print(f"âœ… å¤‡ä»½å®Œæˆï¼ç°åœ¨å»è¿è¡Œè®­ç»ƒå§ã€‚")
    else:
        print("âš ï¸ æœªæ‰¾åˆ° uv_lookup.npzï¼Œè¯·æ£€æŸ¥ä¸Šæ–¹æŠ¥é”™")
else:
    print(f"âŒ æ‰¾ä¸åˆ°é¡¹ç›®ç›®å½•: {PROJECT_ROOT_HYBRID}")

"""# Cell 7.1: ä½¿ç”¨ xatlas ä¿®å¤ UV é‡å å¹¶å¯¼å‡º OBJ"""

"""# Cell 9.1: ä½¿ç”¨ xatlas ä¿®å¤ UV é‡å å¹¶å¯¼å‡º OBJ"""

print("\nğŸš€ [Hybrid 1/2 Extra] xatlas UV é‡æ˜ å°„ï¼ˆä¿æŒé¡¶ç‚¹é¡ºåº/ä½ç½®ä¸å˜ï¼‰...")
!source activate hybrid_uv_wheel && pip install xatlas trimesh

PROJECT_ROOT_HYBRID = "/content/jax3d/jax3d/projects/mobilenerf"
DRIVE_HYBRID_ROOT = "/content/drive/MyDrive/Hybrid_Pipeline"
HYBRID_DATA_ROOT = "data/custom/MyNeRFData"
HYBRID_OBJ_NAME = "sponza_gt.obj"

if os.path.exists(PROJECT_ROOT_HYBRID):
    os.chdir(PROJECT_ROOT_HYBRID)
    cmd = f"""
    source activate hybrid_uv_wheel && \
    python uv_unwrap_xatlas.py --input {HYBRID_DATA_ROOT}/{HYBRID_OBJ_NAME} --output {HYBRID_DATA_ROOT}/sponza_gt_unwarpped.obj
    """
    get_ipython().system(f"bash -c '{cmd}'")

    new_obj = os.path.join(PROJECT_ROOT_HYBRID, HYBRID_DATA_ROOT, "sponza_gt_unwarpped.obj")
    if os.path.exists(new_obj):
        print("âœ… xatlas UV é‡æ˜ å°„å®Œæˆï¼Œå·²ç”Ÿæˆ sponza_gt_unwarpped.obj")
        os.system(f"cp '{new_obj}' '{DRIVE_HYBRID_ROOT}/'")
        print("âœ… å·²å¤‡ä»½åˆ° Drive")
    else:
        print("âŒ xatlas é‡æ˜ å°„è¾“å‡ºä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ—¥å¿—")
else:
    print(f"âŒ æ‰¾ä¸åˆ°é¡¹ç›®ç›®å½•: {PROJECT_ROOT_HYBRID}")

"""# Cell 7.2: æ¸²æŸ“å¯¹æ¯”æµ‹è¯• - render_comparison_test.py"""

import os
from IPython import get_ipython

PROJECT_ROOT_HYBRID = "/content/jax3d/jax3d/projects/mobilenerf"

print("\nğŸš€ [Hybrid 1/2 Extra] è¿è¡Œ render_comparison_test.py åšå‡ ä½•ä¸€è‡´æ€§å¯¹æ¯”...")

if os.path.exists(PROJECT_ROOT_HYBRID):
    os.chdir(PROJECT_ROOT_HYBRID)
    cmd = """
    source activate hybrid_uv_wheel && \
    python render_comparison_test.py
    """
    get_ipython().system(f"bash -c '{cmd}'")
else:
    print(f"âŒ æ‰¾ä¸åˆ°é¡¹ç›®ç›®å½•: {PROJECT_ROOT_HYBRID}")

"""# Cell 8: Hybrid Pipeline Step 2 - è®­ç»ƒ Hybrid Texture + MLP"""

"""# Cell 11: Hybrid Pipeline Step 2 - è®­ç»ƒ Hybrid Texture + MLP"""

import os
import time
import threading
from IPython import get_ipython
from google.colab import drive

PROJECT_ROOT_HYBRID = "/content/jax3d/jax3d/projects/mobilenerf"
DRIVE_HYBRID_ROOT = "/content/drive/MyDrive/Hybrid_Pipeline"


HYBRID_DATA_ROOT_TRAIN = "data/custom/MyNeRFData"
HYBRID_UV_PATH_TRAIN = os.path.join(HYBRID_DATA_ROOT_TRAIN, "uv_lookup.npz")

HYBRID_TEXTURE_SIZE = 4096
HYBRID_BATCH_SIZE = 1024
HYBRID_NUM_ITERS = 150000
HYBRID_LR = 3e-4
HYBRID_DOWNSCALE_TRAIN = 1

HYBRID_CHECKPOINT_PATH = "weights/hybrid_texture_mlp.pth"
HYBRID_ENV_PYTHON = "python"

print("\nğŸš€ [Hybrid 2/2] å¯åŠ¨ Hybrid Texture + MLP è®­ç»ƒ...")

if not os.path.exists("/content/drive"):
    drive.mount("/content/drive")

if not os.path.exists(DRIVE_HYBRID_ROOT):
    os.makedirs(DRIVE_HYBRID_ROOT)

local_weights = os.path.join(PROJECT_ROOT_HYBRID, "weights")
local_samples = os.path.join(PROJECT_ROOT_HYBRID, "samples")
dst_weights = os.path.join(DRIVE_HYBRID_ROOT, "weights")
dst_samples = os.path.join(DRIVE_HYBRID_ROOT, "samples")

def hybrid_background_backup():
    while True:
        try:
            if os.path.exists(local_weights):
                if not os.path.exists(dst_weights):
                    os.makedirs(dst_weights)
                os.system(f"cp -ru '{local_weights}/.' '{dst_weights}/'")
            if os.path.exists(local_samples):
                if not os.path.exists(dst_samples):
                    os.makedirs(dst_samples)
                os.system(f"cp -ru '{local_samples}/.' '{dst_samples}/'")
        except:
            pass
        time.sleep(60)

t = threading.Thread(target=hybrid_background_backup)
t.daemon = True
t.start()

local_uv_path = os.path.join(PROJECT_ROOT_HYBRID, HYBRID_UV_PATH_TRAIN)
drive_uv_path = os.path.join(DRIVE_HYBRID_ROOT, os.path.basename(HYBRID_UV_PATH_TRAIN))

if not os.path.exists(local_uv_path) and os.path.exists(drive_uv_path):
    os.makedirs(os.path.dirname(local_uv_path), exist_ok=True)
    os.system(f"cp '{drive_uv_path}' '{local_uv_path}'")
    print(f"ğŸ”„ å·²ä» Drive æ¢å¤ uv_lookup.npz åˆ°æœ¬åœ°: {local_uv_path}")

if os.path.exists(PROJECT_ROOT_HYBRID):
    os.chdir(PROJECT_ROOT_HYBRID)
    cmd = f"""
export MPLBACKEND=Agg && {HYBRID_ENV_PYTHON} 02_train_hybrid.py \
  --data_root='{HYBRID_DATA_ROOT_TRAIN}' \
  --uv_path='{HYBRID_UV_PATH_TRAIN}' \
  --texture_size={HYBRID_TEXTURE_SIZE} \
  --batch_size={HYBRID_BATCH_SIZE} \
  --num_iters={HYBRID_NUM_ITERS} \
  --lr={HYBRID_LR} \
  --device='auto' \
  --downscale={HYBRID_DOWNSCALE_TRAIN} \
  --checkpoint='{HYBRID_CHECKPOINT_PATH}'
"""
    get_ipython().system(cmd)

    print("\nğŸ“¦ æ­£åœ¨å¤‡ä»½ Hybrid è®­ç»ƒç»“æœåˆ° Drive...")
    if not os.path.exists(DRIVE_HYBRID_ROOT):
        os.makedirs(DRIVE_HYBRID_ROOT)

    local_weights = os.path.join(PROJECT_ROOT_HYBRID, "weights")
    local_samples = os.path.join(PROJECT_ROOT_HYBRID, "samples")

    if os.path.exists(local_weights):
        dst_weights = os.path.join(DRIVE_HYBRID_ROOT, "weights")
        if not os.path.exists(dst_weights):
            os.makedirs(dst_weights)
        os.system(f"cp -ru '{local_weights}/.' '{dst_weights}/'")

    if os.path.exists(local_samples):
        dst_samples = os.path.join(DRIVE_HYBRID_ROOT, "samples")
        if not os.path.exists(dst_samples):
            os.makedirs(dst_samples)
        os.system(f"cp -ru '{local_samples}/.' '{dst_samples}/'")

    print(f"\nâœ… Hybrid è®­ç»ƒç»“æœå·²ä¿å­˜è‡³: {DRIVE_HYBRID_ROOT}")
else:
    print(f"âŒ æ‰¾ä¸åˆ°é¡¹ç›®ç›®å½•: {PROJECT_ROOT_HYBRID}")
